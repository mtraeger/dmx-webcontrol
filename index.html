<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>DMX Lichtschalter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <link href="./css/bootstrap-combined.min.css" rel="stylesheet">
    <link href="./css/slider.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">

    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery-ui.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        function get_html_id(universe, channel) {
            return 'channel_' + universe + '_' + channel;
        }

        var socket = io.connect();
        socket.on('init', function (msg) {
            $('#presets').empty();
            $('#sliders').empty();
            $('#switching').empty();
            $('#colors').empty();
            $('#scripts').empty();
            $('#navbar-content').empty();
            setup = msg.setup;
            devices = msg.devices;
            fadingEffect = 'linear';

            //select easing
            var easingEffects = ["linear", "inBounce", "outBounce", "inOutBounce", "inSine", "outSine", "inOutSine", "inCubic", "outCubic", "inOutCubic", "inQuint", "outQuint", "inOutQuint", "inCirc", "outCirc", "inOutCirc"]; //TODO get (more) effects from easing.js (be careful with overfilling values!)
            var easingSelect = "<select id='easingSelect'>";
            for (var easingEffect in easingEffects) {
                easingSelect += "<option value='"+easingEffects[easingEffect]+"'>Ease "+easingEffects[easingEffect]+"</option>";
            }
            easingSelect += "</select>";
            var dropDown = $(easingSelect)
            dropDown.hide().appendTo('#navbar-content').fadeIn();
            dropDown.change(function (effect) {
                return function () {
                    socket.emit("fadingEaseChange", effect.val());
                };
            }(dropDown));

            //Fading Time
            var html2 = "<div id='fadecontainer' style='float: left;'>";
            html2 += '<label for="fade">Fade duration <span id="fadingTime">0</span> sec</label>';
            html2 += "</div>";
            $(html2).hide().appendTo('#navbar-content').fadeIn();
            var fader = $('<input id="fade" type="range" orient="horizontal" min="0" value="0" max="100">');
            fader.hide().appendTo('#fadecontainer').fadeIn();
            fader.on("input", function (e) {
                socket.emit('fading', e.target.value);
            });

            /* blackout button */
            var blackout = $('<button id="blackout" class="span2 btn btn-danger" style="float: right">Black Out</button>');
            blackout.hide().appendTo('#navbar-content').fadeIn();
            blackout.click(function () {
                for (var universe in setup.universes) {
                    socket.emit('blackout', universe);
                }
            });


            /* preset buttons */
            for (var preset in setup.presets) {
                var html = '<button class="span2 btn btn-info">' + setup.presets[preset].label + '</button>';
                var e = $(html)
                e.hide().appendTo('#presets').fadeIn();
                e.click(function (values) {
                    return function () {
                        for (var universe in values) {
                            if(fadingEffect == 'linear'){
                                socket.emit('update', universe, values[universe]);
                            }else{
                                socket.emit('update', universe, values[universe], true);
                            }
                        }
                    };
                }(setup.presets[preset].values));
//                console.log(html);
            }


            //Switching Presets Time
            var html3 = "<div style='display: block' id='switchpresets'><h2>Switch</h2>";
            html3 += '<label for="switch">Switching Speed (0 = Off)</label>';
            html3 += '<div>Current Step: <span id="switchTime">0</span> seconds</div>';
            html3 += "</div>";
            $(html3).hide().appendTo('#switching').fadeIn();
            var switchfader = $('<input id="switch" type="range" orient="vertical" min="0" value="0" max="100">');
            switchfader.hide().appendTo('#switchpresets').fadeIn();
            switchfader.on("input", function (e) {
                socket.emit('switching', e.target.value);
            });

            //Next step button
            var nextSwitchStep = $('<button class="span2 btn btn-info">Next Step</button>');
            nextSwitchStep.hide().appendTo('#switchpresets').fadeIn();
            nextSwitchStep.click(function () {
                socket.emit('nextSwitchStep');
            });

            //TODO add link to /beat for automatic beat detection

            //switching strategies
            var switchingStrategies = ["colors", "colorsDevByDev", "presets", "colorsSingleDevByDev"]; //TODO get effects from source?
            $("<div id='switchingStrategies' style='clear: both;'><h2>Switching Strategies</h2></div>").hide().appendTo('#switching').fadeIn();
            for (var strategy in switchingStrategies) {
                var strategyButton = $('<button value="'+switchingStrategies[strategy]+'" class="span2 btn btn-info">'+switchingStrategies[strategy]+' Strategy</button>');
                strategyButton.hide().appendTo('#switchingStrategies').fadeIn();
                strategyButton.click(function (e) {
                    socket.emit('switchingStrategy', e.target.value);
                });
            }


            //Color page
            // color buttons and color sliders for rgb (additional color sliders?)
            for (var color in setup.colors) {
                var htmlColorButtons = '<button class="span2 btn btn-info">' + setup.colors[color].label + '</button>';
                var e = $(htmlColorButtons)
                e.hide().appendTo('#colors').fadeIn();
                e.click(function (color) {
                    return function () {
                        //TODO code duplication (see below and switching) -> maybe put this to dmx-web.js
                        for (var universe in setup.universes) {
                            var update = {};
                            for (var device in setup.universes[universe].devices) {
                                var dev = setup.universes[universe].devices[device];
                                if(devices[dev.type].hasOwnProperty("startRgbChannel")){
                                    var startRgb = devices[dev.type].startRgbChannel;
                                    var firstRgbChannelForDevice = dev.address + startRgb;
                                    for (var colorChannel in color.values){
                                        var updateChannel = parseInt(colorChannel) + firstRgbChannelForDevice;
                                        update[updateChannel] = color.values[colorChannel];
                                    }

                                }
                            }
                            //socket.emit('update', universe, update);
                            if(fadingEffect == 'linear'){
                                socket.emit('update', universe, update);
                            }else{
                                socket.emit('update', universe, update, true);
                            }
                        }
                    };
                }(setup.colors[color]));
            }
            //color slider //TODO update moved sliders on all clients, update sliders on color button update
            $('<div id="colorSliders" class="device" style="display: block;">').appendTo('#colors')
            var rgbColor = {0:"red", 1:"green", 2:"blue"};
            for (var color in rgbColor) {
                var rgbGroup = $("<div class='channel'>").appendTo('#colorSliders');
                var html2 = "";
                html2 += '<label for="rgb'+rgbColor[color]+'">'+rgbColor[color]+'</label>';
                html2 += "";
                $(html2).hide().appendTo(rgbGroup).fadeIn();
                var fader = $('<input id="rgb'+rgbColor[color]+'" type="range" orient="vertical" min="0" value="0" max="255">');
                fader.hide().appendTo(rgbGroup).fadeIn();
                fader.on("input", function (e) {
                        //TODO reduce code duplication (see buttons above)
                        for (var universe in setup.universes) {
                            var update = {};
                            for (var device in setup.universes[universe].devices) {
                                var dev = setup.universes[universe].devices[device];
                                if (devices[dev.type].hasOwnProperty("startRgbChannel")) {
                                    var startRgb = devices[dev.type].startRgbChannel;
                                    var firstRgbChannelForDevice = dev.address + startRgb;

                                    var colorAdd = 0;
                                    if ($(e.target)[0].id == "rgbgreen") {
                                        colorAdd = 1;
                                    } else if ($(e.target)[0].id == "rgbblue") {
                                        colorAdd = 2;
                                    }

                                    var updateChannel = parseInt(colorAdd) + firstRgbChannelForDevice;
                                    update[updateChannel] = e.target.value;
                                }
                            }
                            socket.emit('update', universe, update);
                        }
                });
            }


            /* sliders */
            for (var universe in setup.universes) {
                var html = "<div><h1>" + universe + "</h1>";
                for (var device in setup.universes[universe].devices) {
                    var dev = setup.universes[universe].devices[device];
                    html += '<div class="device">'
                    for (var channel in devices[dev.type].channels) {
                        var channel_id = dev.address + Number(channel)
                        var html_id = get_html_id(universe, channel_id);
                        html += '<div class="channel">'
                        html += '<label for="' + html_id + '">' + devices[dev.type].channels[channel] + '</label>';
                        html += '<input  id="' + html_id + '" type="range" orient="vertical" min="0" value="0" max="255">'
                        html += '<input  id="' + html_id + '_display" class="displayslider" disabled type="range" orient="vertical" min="0" value="0" max="255">'
                        html += '</div>'
                    }
                    html += '</div>'
                }
                html += "</div>";
                $(html).hide().appendTo('#sliders').fadeIn();
            }
            $("input").live("change", function (e) {
                updateDmx(e, false);
            });
            $("input").live("input", function (e) {
                updateDmx(e, false);
            });
            socket.emit('request_refresh');
        });

        function updateDmx(e, effect) {
            if (e.target.id.startsWith("channel_")) {
                var i = e.target.id.split('_');
                var u = {};
                u[i[2]] = e.target.value;
                socket.emit('update', i[1], u, effect);
            }
        }

        socket.on('update', function (universe, update) {
            for (var k in update) {
                $('#' + get_html_id(universe, k)).attr('value', update[k]);
                $('#' + get_html_id(universe, k)+'_display').attr('value', update[k]);
            }
        });
        socket.on('displayslider', function (universe, update) {
            for (var k in update) {
                $('#' + get_html_id(universe, k)+'_display').attr('value', update[k]);
            }
        });
        var blackoutBlinker;
        socket.on('blackout', function (blackout) { //TODO use 2nd blackout param for different universes
            if(blackout) {
                $('#blackout').addClass('active');
                blackoutBlinker = window.setInterval(function(){
                    $('#blackout').toggleClass('blink');
                }, 500);
            }else {
                window.clearInterval(blackoutBlinker);
                $('#blackout').removeClass('active');
                $('#blackout').removeClass('blink');
            }
        });
        socket.on('fade', function (duration, ease, fadingTime) {
            $('#fade').attr('value', duration);
            $('#fadingTime').text(fadingTime);
        });
        socket.on('fadingEaseChange', function (effect) {
            $('#easingSelect').val(effect);
            fadingEffect = effect;
        });
        socket.on('switching', function (duration, time) {
            $('#switch').attr('value', duration);
            $('#switchTime').text(time);
        });
    </script>
</head>
<body>
<div class="navbar navbar-inverse">
    <div class="navbar-inner">
        <ul class="nav" id="myTab">
            <li class="active"><a href="#home" data-toggle="tab">Home</a></li>
            <li><a href="#sliders" data-toggle="tab">Sliders</a></li>
            <li><a href="#switching" data-toggle="tab">Switching</a></li>
            <li><a href="#colors" data-toggle="tab">Colors</a></li>
            <li><a href="#scripts" data-toggle="tab">Scripts</a></li>
        </ul>
        <div id="navbar-content">

        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="tab-content">
        <div id="home" class="tab-pane active">
            <div class="row-fluid" id="presets">
            </div>
        </div>
        <div id="sliders" class="tab-pane">

        </div>
        <div id="switching" class="tab-pane">
            <div class="row-fluid" id="switching-strategies">
            </div>
        </div>
        <div id="colors" class="tab-pane">

        </div>
        <div id="scripts" class="tab-pane">

        </div>
    </div>
</div>
</body>
</html>
