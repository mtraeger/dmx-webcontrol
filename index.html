<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>DMX Lichtschalter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <link href="./css/bootstrap-combined.min.css" rel="stylesheet">
    <link href="./css/slider.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">

    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery-ui.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        function get_html_id(universe, channel) {
            return 'channel_' + universe + '_' + channel;
        }

        var socket = io.connect();
        socket.on('init', function (msg) {
            $('#presets').empty();
            $('#sliders').empty();
            $('#scripts').empty();
            setup = msg.setup
            devices = msg.devices

            /* preset buttons */
            for (var preset in setup.presets) {
                var html = '<button class="span2 btn btn-info">' + setup.presets[preset].label + '</button>';
                var e = $(html)
                e.hide().appendTo('#presets').fadeIn();
                e.click(function (values) {
                    return function () {
                        for (var universe in values) {
                            socket.emit('update', universe, values[universe]);
                        }
                    };
                }(setup.presets[preset].values));
                console.log(html);
            }

            /* blackout button */
            var blackout = $('<button class="span2 btn btn-danger">Black Out</button>');
            blackout.hide().appendTo('#presets').fadeIn();
            blackout.click(function () {
                for (var universe in setup.universes) {
                    socket.emit('blackout', universe);
                }
            });


            //Scripts
            var html2 = "<div id='fadecontainer'><h1>Fade</h1>";
            html2 += '<label for="fade">Fade duration</label>';
            html2 += "</div>";
            $(html2).hide().appendTo('#scripts').fadeIn();
            var fader = $('<input id="fade" type="range" orient="vertical" min="0" value="0" max="100">');
            fader.hide().appendTo('#fadecontainer').fadeIn();
            fader.on("change", function (e) {
                socket.emit('fading', e.target.value);
            })

            //TODO select easing methods
            //TODO start custom scripts


            //TODO buttons for config channel or input[type=range] datalist
            /* sliders */
            for (var universe in setup.universes) {
                var html = "<div><h1>" + universe + "</h1>";
                for (var device in setup.universes[universe].devices) {
                    var dev = setup.universes[universe].devices[device];
                    html += '<div class="device">'
                    for (var channel in devices[dev.type].channels) {
                        var channel_id = dev.address + Number(channel)
                        var html_id = get_html_id(universe, channel_id);
                        html += '<div class="channel">'
                        html += '<label for="' + html_id + '">' + devices[dev.type].channels[channel] + '</label>';
                        html += '<input  id="' + html_id + '" type="range" orient="vertical" min="0" value="0" max="255">'
                        html += '<input  id="' + html_id + '_display" class="displayslider" disabled type="range" orient="vertical" min="0" value="0" max="255">'
                        html += '</div>'
                    }
                    html += '</div>'
                }
                html += "</div>";
                $(html).hide().appendTo('#sliders').fadeIn();
            }
            $("input").live("change", function (e) {
//                console.log(e.target.parentNode.parentNode.parentNode.parentNode.id);
                if (e.target.parentNode.parentNode.parentNode.parentNode.id == "sliders") {
                    var i = e.target.id.split('_');
                    var u = {};
                    u[i[2]] = e.target.value;
                    socket.emit('update', i[1], u);
                }
            });
            socket.emit('request_refresh');
        });
        socket.on('update', function (universe, update) {
            for (var k in update) {
                $('#' + get_html_id(universe, k)).attr('value', update[k]);
                $('#' + get_html_id(universe, k)+'_display').attr('value', update[k]);
            }
        });
        socket.on('displayslider', function (universe, update) {
            for (var k in update) {
                $('#' + get_html_id(universe, k)+'_display').attr('value', update[k]);
            }
        });
        socket.on('fade', function (duration, ease) {
            $('#fade').attr('value', duration);
            //TODO update ease effect
        });
    </script>
</head>
<body>
<div class="navbar navbar-inverse">
    <div class="navbar-inner">
        <ul class="nav" id="myTab">
            <li class="active"><a href="#home" data-toggle="tab">Home</a></li>
            <li><a href="#sliders" data-toggle="tab">Sliders</a></li>
            <li><a href="#scripts" data-toggle="tab">Scripts</a></li>
        </ul>
    </div>
</div>

<div class="container-fluid">
    <div class="tab-content">
        <div id="home" class="tab-pane active">
            <div class="row-fluid" id="presets">
            </div>
        </div>
        <div id="sliders" class="tab-pane">

        </div>
        <div id="scripts" class="tab-pane">

        </div>
    </div>
</div>
</body>
</html>