<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>DMX Lichtschalter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <link href="./css/bootstrap-combined.min.css" rel="stylesheet">
    <link href="./css/slider.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">

    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery-ui.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        function get_html_id(universe, channel) {
            return 'channel_' + universe + '_' + channel;
        }

        var socket = io.connect();
        socket.on('init', function (msg) {
            $('#presets').empty();
            $('#sliders').empty();
            $('#scripts').empty();
            $('#colors').empty();
            $('#navbar-content').empty();
            setup = msg.setup
            devices = msg.devices
            fadingEffect = 'linear';

            //select easing
            var easingEffects = ["linear", "outBounce", "inOutCubic", "inOutQuint"]; //TODO get effects from source
            var easingSelect = "<select id='easingSelect'>";
            for (var easingEffect in easingEffects) {
                easingSelect += "<option value='"+easingEffects[easingEffect]+"'>"+easingEffects[easingEffect]+"</option>";
            }
            easingSelect += "</select>";
            var dropDown = $(easingSelect)
            dropDown.hide().appendTo('#presets').fadeIn();
            dropDown.change(function (effect) {
                return function () {
                    socket.emit("fadingEaseChange", effect.val());
                };
            }(dropDown));

            /* preset buttons */
            for (var preset in setup.presets) {
                var html = '<button class="span2 btn btn-info">' + setup.presets[preset].label + '</button>';
                var e = $(html)
                e.hide().appendTo('#presets').fadeIn();
                e.click(function (values) {
                    return function () {
                        for (var universe in values) {
                            if(fadingEffect == 'linear'){
                                socket.emit('update', universe, values[universe]);
                            }else{
                                socket.emit('update', universe, values[universe], true);
                            }
                        }
                    };
                }(setup.presets[preset].values));
//                console.log(html);
            }

            /* blackout button */
            var blackout = $('<button id="blackout" class="span2 btn btn-danger">Black Out</button>');
            blackout.hide().appendTo('#navbar-content').fadeIn();
            blackout.click(function () {
                for (var universe in setup.universes) {
                    socket.emit('blackout', universe);
                }
            });


            //Fading Time //TODO add to #navbar-content
            var html2 = "<div id='fadecontainer'><h2>Fade</h2>";
            html2 += '<label for="fade">Fade duration</label>';
            html2 += "</div>";
            $(html2).hide().appendTo('#sliders').fadeIn();
            var fader = $('<input id="fade" type="range" orient="horizontal" min="0" value="0" max="300">');
            fader.hide().appendTo('#fadecontainer').fadeIn();
            fader.on("input", function (e) {
                socket.emit('fading', e.target.value);
            });


            //Switching Presets Time
            var html3 = "<div id='switchpresets'><h2>Switch</h2>";
            html3 += '<label for="switch">Switch presets Speed -- 0 = Off</label>';
            html3 += "</div>";
            $(html3).hide().appendTo('#scripts').fadeIn();
            var switchfader = $('<input id="switch" type="range" orient="vertical" min="0" value="0" max="300">'); //TODO time?
            switchfader.hide().appendTo('#switchpresets').fadeIn();
            switchfader.on("input", function (e) {
                socket.emit('switching', e.target.value);
            });
            //TODO select presets for animation from list?
            //TODO also buttons to click manual effects? -> effect-fade on click, button list like home?


            //Color page
            // color buttons and color sliders for rgb (additional color sliders?)
            for (var color in setup.colors) {
                var htmlColorButtons = '<button class="span2 btn btn-info">' + setup.colors[color].label + '</button>';
                var e = $(htmlColorButtons)
                e.hide().appendTo('#colors').fadeIn();
                e.click(function (color) {
                    return function () {
                        for (var universe in setup.universes) {
                            var update = {};
                            for (var device in setup.universes[universe].devices) {
                                var dev = setup.universes[universe].devices[device];
                                if(devices[dev.type].hasOwnProperty("startRgbChannel")){
                                    var startRgb = devices[dev.type].startRgbChannel;
                                    var firstRgbChannelForDevice = dev.address + startRgb;
                                    for (var colorChannel in color.values){
                                        var updateChannel = parseInt(colorChannel) + firstRgbChannelForDevice;
                                        update[updateChannel] = color.values[colorChannel];
                                    }

                                    //TODO special override colors from device config - code below from sliders...
                                    //use color.label for naming convention
//                                    for (var overrideColor in devices[dev.type].colors) {
//                                        var channel_id = dev.address + Number(overrideColor)
//                                        html += '<label for="' + html_id + '">' + devices[dev.type].channels[overrideColor] + '</label>';
//                                    }

                                }
                            }
                            //socket.emit('update', universe, update);
                            if(fadingEffect == 'linear'){
                                socket.emit('update', universe, update);
                            }else{
                                socket.emit('update', universe, update, true);
                            }
                            // socket.emit('update', universe, values[universe], true); //TODO enable effect mode by button also here
                        }
                    };
                }(setup.colors[color]));
            }
            //color slider //TODO update moved sliders on all clients
            $('<div id="colorSliders" class="device" style="display: block;">').appendTo('#colors')
            var rgbColor = {0:"red", 1:"green", 2:"blue"}; //TODO add other colors - amber, white, uv?
            for (var color in rgbColor) {
                var rgbGroup = $("<div class='channel'>").appendTo('#colorSliders');
                var html2 = "";
                html2 += '<label for="rgb'+rgbColor[color]+'">'+rgbColor[color]+'</label>';
                html2 += "";
                $(html2).hide().appendTo(rgbGroup).fadeIn();
                var fader = $('<input id="rgb'+rgbColor[color]+'" type="range" orient="vertical" min="0" value="0" max="255">');
                fader.hide().appendTo(rgbGroup).fadeIn();
                fader.on("input", function (e) {
                        //TODO reduce code duplication (see buttons above)
                        for (var universe in setup.universes) {
                            var update = {};
                            for (var device in setup.universes[universe].devices) {
                                var dev = setup.universes[universe].devices[device];
                                if (devices[dev.type].hasOwnProperty("startRgbChannel")) {
                                    var startRgb = devices[dev.type].startRgbChannel;
                                    var firstRgbChannelForDevice = dev.address + startRgb;

                                    //TODO dirty - pass color var here and use it instead of colorAdd
                                    var colorAdd = 0;
                                    if ($(e.target)[0].id == "rgbgreen") {
                                        colorAdd = 1;
                                    } else if ($(e.target)[0].id == "rgbblue") {
                                        colorAdd = 2;
                                    }

                                    var updateChannel = parseInt(colorAdd) + firstRgbChannelForDevice;
                                    update[updateChannel] = e.target.value;
                                }
                            }
                            socket.emit('update', universe, update);
                        }
                });
            }


            //TODO show heading for color in this color if color exists (or if color)
            //TODO slider for each color -> affect automatic all devices (by name?)

            //TODO presets for each device and then call presets in presets? -> white(dev1:white, dev2:white, dev4:white)?

            //TODO limit presets / effects ... to device?

            //TODO color chooser wheel -> select device? -> all or one or multiple?

            //TODO export current state to json for preset or to code for animation? -> record animations?

            //TODO strobo / random strobo? -> reandom over devices?

            //TODO master dimmer slider? for all / selected channels?

            //TODO scripts page
            //TODO select easing methods -> drop down menu
            //TODO start custom scripts

            //TODO color selection like in adobe kuler? -> similar color suggestions?


            //TODO show current values for slider
            //TODO buttons for config channel or input[type=range] datalist
            /* sliders */
            for (var universe in setup.universes) {
                var html = "<div><h1>" + universe + "</h1>";
                for (var device in setup.universes[universe].devices) {
                    var dev = setup.universes[universe].devices[device];
                    html += '<div class="device">'
                    for (var channel in devices[dev.type].channels) {
                        var channel_id = dev.address + Number(channel)
                        var html_id = get_html_id(universe, channel_id);
                        html += '<div class="channel">'
                        html += '<label for="' + html_id + '">' + devices[dev.type].channels[channel] + '</label>';
                        html += '<input  id="' + html_id + '" type="range" orient="vertical" min="0" value="0" max="255">'
                        html += '<input  id="' + html_id + '_display" class="displayslider" disabled type="range" orient="vertical" min="0" value="0" max="255">'
                        html += '</div>'
                    }
                    html += '</div>'
                }
                html += "</div>";
                $(html).hide().appendTo('#sliders').fadeIn();
            }
            $("input").live("change", function (e) {//TODO combine both calls again?
                updateDmx(e, false);
            });
            $("input").live("input", function (e) {
                updateDmx(e, false);
            });
            socket.emit('request_refresh');
        });

        function updateDmx(e, effect) { //TODO combine both calls again?
            if (e.target.id.startsWith("channel_")) {
                var i = e.target.id.split('_');
                var u = {};
                u[i[2]] = e.target.value;
                socket.emit('update', i[1], u, effect);
            }
        }

        socket.on('update', function (universe, update) {
            for (var k in update) {
                $('#' + get_html_id(universe, k)).attr('value', update[k]);
                $('#' + get_html_id(universe, k)+'_display').attr('value', update[k]);
            }
        });
        socket.on('displayslider', function (universe, update) {
            for (var k in update) {
                $('#' + get_html_id(universe, k)+'_display').attr('value', update[k]);
            }
        });
        var blackoutBlinker;
        socket.on('blackout', function (blackout) {
            if(blackout) {
                $('#blackout').addClass('active');
                blackoutBlinker = window.setInterval(function(){
                    $('#blackout').toggleClass('blink');
                }, 500);
            }else {
                window.clearInterval(blackoutBlinker);
                $('#blackout').removeClass('active');
                $('#blackout').removeClass('blink');
            }
        });
        socket.on('fade', function (duration, ease) {
            $('#fade').attr('value', duration);
            //TODO update ease effect
        });
        socket.on('fadingEaseChange', function (effect) {
            $('#easingSelect').val(effect);
            fadingEffect = effect;
        })
    </script>
</head>
<body>
<div class="navbar navbar-inverse">
    <div class="navbar-inner">
        <ul class="nav" id="myTab">
            <li class="active"><a href="#home" data-toggle="tab">Home</a></li>
            <li><a href="#sliders" data-toggle="tab">Sliders</a></li>
            <li><a href="#scripts" data-toggle="tab">Scripts</a></li>
            <li><a href="#colors" data-toggle="tab">Colors</a></li>
        </ul>
        <div id="navbar-content">

        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="tab-content">
        <div id="home" class="tab-pane active">
            <div class="row-fluid" id="presets">
            </div>
        </div>
        <div id="sliders" class="tab-pane">

        </div>
        <div id="scripts" class="tab-pane">

        </div>
        <div id="colors" class="tab-pane">

        </div>
    </div>
</div>
</body>
</html>